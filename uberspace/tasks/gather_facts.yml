- name: Get datasheet page
  delegate_to: localhost
  uri:
    url: "{{ uberspace_urls.datasheet }}"
    headers: "{{ uberspace_headers }}"
    return_content: yes
  register: datasheetresult

- name: Set uberspace facts from dashboard
  set_fact:
    uberspace_ip_public_v4: "{{ parsed_ipv4address }}"
    uberspace_ip_public_v6: "{{ parsed_ipv6address }}"

- name: Put host keys into local known_hosts
  delegate_to: localhost
  vars:
    hostkey: "{{ lookup('pipe','ssh-keyscan -t '+item+' '+uberspace_domain+' 2>/dev/null | cut -d \" \" -f 1 --complement') }}"
    actual_hostkey_fingerprint: "{{ lookup('pipe','echo \"'+hostkey+'\" | ssh-keygen -l -f - | cut -d \" \" -f 2 | cut -d \":\" -f 2') }}"
    ssh_hostnames:
    - "{{ uberspace_domain }}"
    - "{{ uberspace_ip_public_v4 }}"
    - "{{ uberspace_ip_public_v6 }}"
  loop:
  - ed25519
  - rsa
  when: actual_hostkey_fingerprint == parsed_hostkeyfingerprint
  known_hosts:
    name: "{{ uberspace_domain }}"
    key: "{{ ssh_hostnames | join(',') }} {{ hostkey }}"

- name: Gather facts
  gather_facts:

- name: Set uberspace facts from ansible facts
  set_fact:
    uberspace_ip_private_v4: "{{ ansible_default_ipv4 }}"
    uberspace_ip_private_v6: "{{ ansible_default_ipv6 }}"
    uberspace_host: "{{ ansible_hostname }}"

- name: List ports
  tags: ports
  command: "uberspace port list"
  changed_when: false
  register: uberspace_curports
- name: Store ports as fact
  tags: ports
  set_fact:
    uberspace_curports: "{{ uberspace_curports.stdout_lines }}"

- name: List domains
  tags: domains
  command: "uberspace web domain list"
  changed_when: false
  register: uberspace_domains
- name: Store domains as fact
  tags: domains
  set_fact:
    uberspace_domains: "{{ uberspace_domains.stdout_lines }}"
